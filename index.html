import { defineConfig } from "vite";
import webfontDownload from "vite-plugin-webfont-dl";
import { ViteMinifyPlugin } from "vite-plugin-minify";
const IN_PRODUCTION = process.env.NODE_ENV === "production";
const IN_DEVELOPMENT = process.env.NODE_ENV === "development";

// Hide Preloader in all environments
const disablePreloader = () => {
  return {
    name: "disable-preloader",
    transformIndexHtml(html) {
      // Insert style to hide preloader
      return html.replace(
        `<link rel="stylesheet" href="./src/css/preloader.min.css" type="text/css">`,
        `<style>#loader-wrapper{display:none !important;}</style>
        <link rel="stylesheet" href="./src/css/preloader.min.css" type="text/css">`
      );
    }
  }
}

// Add script to force hide preloader
const addPreloaderDisabler = () => {
  return {
    name: "add-preloader-disabler",
    transformIndexHtml(html) {
      return html.replace(
        `<body itemtype="https://schema.org/WebPage" itemscope="itemscope" class="carclub">`,
        `<body itemtype="https://schema.org/WebPage" itemscope="itemscope" class="carclub">
        <script>
          // Force hide preloader immediately
          document.addEventListener('DOMContentLoaded', function() {
            var loader = document.getElementById('loader-wrapper');
            if (loader) loader.style.display = 'none';
          });
          // Also force hide with a timer
          setTimeout(function() {
            var loader = document.getElementById('loader-wrapper');
            if (loader) loader.style.display = 'none';
          }, 100);
        </script>`
      );
    }
  }
}

// Copy index to real-index
const copyIndexToRealIndex = () => {
  return {
    name: "copy-index-to-real-index",
    generateBundle(options, bundle) {
      if (bundle['index.html']) {
        bundle['real-index.html'] = { ...bundle['index.html'] };
      }
    }
  }
}

// Create redirect index
const createRedirectIndex = () => {
  return {
    name: "create-redirect-index",
    generateBundle(options, bundle) {
      bundle['index.html'] = {
        type: 'asset',
        fileName: 'index.html',
        source: `<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="refresh" content="0;url=./real-index.html">
  <title>Redirecting...</title>
  <script>
    window.location.href = "./real-index.html?preloader=disable";
  </script>
</head>
<body>
  <p>Please wait, redirecting to the site...</p>
</body>
</html>`
      };
    }
  }
}

export default defineConfig({
  plugins: [
    // Disable preloader in all environments
    disablePreloader(),
    
    // Add preloader disabler script
    addPreloaderDisabler(),
    
    // In production, handle the redirect approach
    IN_PRODUCTION && copyIndexToRealIndex(),
    IN_PRODUCTION && createRedirectIndex(),

    // Download Google Fonts for offline use
    IN_PRODUCTION && webfontDownload(
      [
        "https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap",
      ]
    ),

    // Minify HTML
    IN_PRODUCTION && ViteMinifyPlugin({}),
  ],

  css: {
    preprocessorOptions: {
      scss: {
        api: 'modern',
      }
    }
  },

  // Use repository name as base
  base: "/car-mechanic-shop/",
  
  server: {
    port: 3000,
  },

  build: {
    minify: 'terser',
    terserOptions: {
      format: {
        comments: false,
      },
    },
  },
});
